<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Make your own Heatmap</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
  <style>
    body { background:#fff; }
    .section-card { border:1px solid #e5e5e5; border-radius:8px; padding:12px; background:#fff; }
    .section-card h6 { font-weight:600; margin-bottom:8px; }
    .sticky-actions { position: sticky; bottom:0; background:#fff; padding:12px 0; }
    .tiny { font-size:12px; }
    .plot-wrap { width:100%; min-height:60vh; }
    .plot-wrap .js-plotly-plot { width:100% !important; }
  </style>
</head>
<body>
<div class="container-fluid py-3">
  <h4 class="mb-3">Make your own Heatmap</h4>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-warning">{% for m in messages %}<div>{{ m }}</div>{% endfor %}</div>
    {% endif %}
  {% endwith %}

  <div class="row">
    <!-- Upload form -->
    <div class="col-lg-3 mb-3">
      <form action="/upload" method="POST" enctype="multipart/form-data" class="section-card">
        <h6>Choose CSV File</h6>
        <div class="custom-file mb-2">
          <input type="file" name="file" class="custom-file-input" id="csvFile" required>
          <label class="custom-file-label" for="csvFile">No file selected</label>
        </div>
        <div class="tiny text-muted">Timestamp must be in format <code>%d-%m-%y %H:%M</code></div>
        <button type="submit" class="btn btn-primary btn-sm mt-2">Upload</button>
        <hr>
        <div class="tiny text-muted">
          {% if columns %}
            <div><b>Detected columns:</b></div>
            <ul class="mb-0">{% for c in columns %}<li>{{ c }}</li>{% endfor %}</ul>
          {% else %}Upload CSV to view detected columns{% endif %}
        </div>
      </form>
    </div>

    <!-- Generate form -->
    <div class="col-lg-9">
      <form action="/generate-heatmap" method="POST" id="genForm">
        <input type="hidden" name="session_id" value="{{ session_id }}"/>

        <div class="row">
          <!-- Column 1 -->
          <div class="col-lg-4 mb-3">
            <div class="section-card">
              <label>Select your variable</label>
              {% set p = (form.get('parameter') if form else '') %}
              <select name="parameter" id="parameter" class="custom-select" required>
                <option value=""  {{ 'selected' if not p else '' }}>-- Select --</option>
                <option value="DBT" {{ 'selected' if p=='DBT' else '' }}>DBT</option>
                <option value="RH"  {{ 'selected' if p=='RH'  else '' }}>RH</option>
              </select>

              <div class="form-row mt-3">
                <div class="col-6">
                  <label>Add upper band limit time</label>
                  <input type="time" class="form-control" name="upper_limit_time"
                         value="{{ (form.get('upper_limit_time') if form else '') or '09:00' }}">
                </div>
                <div class="col-6">
                  <label>Select type of upper band limit line</label>
                  {% set ust = (form.get('upper_line_style') if form else '') or 'dotted' %}
                  <select class="custom-select" name="upper_line_style">
                    <option {{ 'selected' if ust=='dotted' else '' }}>dotted</option>
                    <option {{ 'selected' if ust=='solid'  else '' }}>solid</option>
                    <option {{ 'selected' if ust=='dash'   else '' }}>dash</option>
                  </select>
                </div>
              </div>

              <div class="form-group mt-2">
                {% set uc = (form.get('upper_line_color') if form else '') or 'black' %}
                <label>Select colour of upper band limit line</label>
                <select class="custom-select" name="upper_line_color">
                  {% for c in ['black','red','blue','green','grey'] %}
                    <option {{ 'selected' if uc==c else '' }}>{{ c }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-row">
                <div class="col-6">
                  <label>Add lower band limit time</label>
                  <input type="time" class="form-control" name="lower_limit_time"
                         value="{{ (form.get('lower_limit_time') if form else '') or '18:00' }}">
                </div>
                <div class="col-6">
                  <label>Select type of lower band limit line</label>
                  {% set lst = (form.get('lower_line_style') if form else '') or 'dotted' %}
                  <select class="custom-select" name="lower_line_style">
                    <option {{ 'selected' if lst=='dotted' else '' }}>dotted</option>
                    <option {{ 'selected' if lst=='solid'  else '' }}>solid</option>
                    <option {{ 'selected' if lst=='dash'   else '' }}>dash</option>
                  </select>
                </div>
              </div>

              <div class="form-group mt-2">
                {% set lc = (form.get('lower_line_color') if form else '') or 'black' %}
                <label>Select colour of lower band limit line</label>
                <select class="custom-select" name="lower_line_color">
                  {% for c in ['black','red','blue','green','grey'] %}
                    <option {{ 'selected' if lc==c else '' }}>{{ c }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <!-- Column 2 -->
          <div class="col-lg-4 mb-3">
            <div class="section-card">
              <label>Select colour of missing value</label>
              {% set miss = (form.get('missing_color') if form else '') or 'Grey' %}
              <select class="custom-select" name="missing_color">
                {% for c in ['Grey','White','Black'] %}
                  <option {{ 'selected' if miss==c else '' }}>{{ c }}</option>
                {% endfor %}
              </select>

              <label class="mt-3">Select range of colours</label>
              <div class="border rounded p-2 mb-2">
                {% set chosen = chosen_colors if chosen_colors is defined else [] %}
                {% for c,idv in [('White','c1'),('Navyblue','c2'),('Blue','c3'),('Cyan','c4'),('Yellow','c5'),('Red','c6'),('Darkred','c7'),('Black','c8')] %}
                  <div class="custom-control custom-checkbox">
                    <input class="custom-control-input" type="checkbox" id="{{ idv }}" name="colors[]" value="{{ c }}"
                           {{ 'checked' if c in chosen else '' }}>
                    <label class="custom-control-label" for="{{ idv }}">{{ c }}</label>
                  </div>
                {% endfor %}
              </div>

              <div class="form-row">
                <div class="col-6">
                  <label>Select variable scale minimum value</label>
                  <input type="number" class="form-control" name="scale_min"
                         value="{{ (form.get('scale_min') if form else '') or 0 }}">
                </div>
                <div class="col-6">
                  <label>Select variable scale maximum value</label>
                  <input type="number" class="form-control" name="scale_max" id="scale_max"
                         value="{{ (form.get('scale_max') if form else '') or '' }}">
                </div>
              </div>
              <div class="form-row mt-2">
                <div class="col-7">
                  <label>Select legend scale increment</label>
                  <input type="number" class="form-control" name="legend_step"
                         value="{{ (form.get('legend_step') if form else '') or 10 }}">
                </div>
                <div class="col-5">
                  <label>X-axis represented by</label>
                  {% set xr = (form.get('x_representation') if form else '') or 'months' %}
                  <select class="custom-select" name="x_representation">
                    {% for c in ['months','weeks','days','years'] %}
                      <option {{ 'selected' if xr==c else '' }}>{{ c }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Column 3 -->
          <div class="col-lg-4 mb-3">
            <div class="section-card">
              <label>Choose your date format</label>
              {% set dfmt = (form.get('date_format') if form else '') or 'Mon-YY' %}
              <div class="border rounded p-2 mb-2">
                {% for v,lab in [
                  ('Mon-YY','Abbreviated month - 2-digit year (Jan-17)'),
                  ('01-Jan','Decimal date - Abbreviated month (01-Jan)'),
                  ('01-01-17','Decimal date - 2 digit year (01-01-17)'),
                  ('01-January','Decimal date - Full month (01-January)'),
                  ('Mon','Abbreviated weekday (Mon)'),
                  ('Monday','Full weekday (Monday)'),
                  ('Jan','Abbreviated month (Jan)'),
                  ('01','Decimal month (01)'),
                  ('17','2-digit year (17)'),
                  ('2017','4-digit year (2017)')
                ] %}
                  <div class="custom-control custom-radio">
                    <input class="custom-control-input" type="radio" id="df{{ v|replace('-','') }}"
                           name="date_format" value="{{ v }}"
                           {{ 'checked' if dfmt==v else '' }}>
                    <label class="custom-control-label" for="df{{ v|replace('-','') }}">{{ lab }}</label>
                  </div>
                {% endfor %}
              </div>

              <label>Enter Title</label>
              <input type="text" class="form-control" name="chart_title" placeholder="Title"
                     value="{{ form.get('chart_title') if form else '' }}">
              <label class="mt-2">Enter X-axis name</label>
              <input type="text" class="form-control" name="x_label" placeholder="X-axis"
                     value="{{ (form.get('x_label') if form else '') or 'Date' }}">
              <label class="mt-2">Enter Y-axis name</label>
              <input type="text" class="form-control" name="y_label" placeholder="Y-axis"
                     value="{{ (form.get('y_label') if form else '') or 'Hour' }}">
              <label class="mt-2">Enter Legend name</label>
              <input type="text" class="form-control" name="legend_label" placeholder="Legend"
                     value="{{ form.get('legend_label') if form else '' }}">

              <div class="form-row mt-2">
                <div class="col-6">
                  <label>Select image width</label>
                  <input type="number" class="form-control" name="image_width"
                         value="{{ (form.get('image_width') if form else form.get('img_width')) or 1200 }}">
                </div>
                <div class="col-6">
                  <label>Select image height</label>
                  <input type="number" class="form-control" name="image_height"
                         value="{{ (form.get('image_height') if form else form.get('img_height')) or 600 }}">
                </div>
              </div>

              <div class="form-group mt-2">
                <label>Select image point size</label>
                <input type="number" class="form-control" step="any" name="point_size"
                       value="{{ (form.get('point_size') if form else '') or 15 }}">
              </div>
            </div>
          </div>
        </div>

        <div class="sticky-actions">
          <button type="submit" class="btn btn-dark" {% if not session_id %}disabled title="Upload a CSV first"{% endif %}>
            Generate Heatmap
          </button>
          <a class="btn btn-outline-secondary ml-2 {% if not session_id %}disabled{% endif %}"
             {% if session_id %}href="{{ url_for('download_plot', fmt='jpg', sid=session_id) }}"{% else %}href="#"{% endif %}>
            Download JPG
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mt-4">
    <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#heatmap">Heatmap</a></li>
    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#data">Data</a></li>
  </ul>
  <div class="tab-content border-left border-right border-bottom p-3">
    <div class="tab-pane fade show active" id="heatmap">
      {% if graph_html %}
        <div class="plot-wrap">{{ graph_html | safe }}</div>
      {% else %}
        <div class="text-muted tiny">Your heatmap will appear here after generation.</div>
      {% endif %}
    </div>
    <div class="tab-pane fade" id="data">
      {% if data_html %}
        {{ data_html | safe }}
      {% elif columns %}
        <div class="tiny text-muted">Columns detected in your CSV (upload again to preview rows):</div>
        <ul class="mb-0">{% for c in columns %}<li>{{ c }}</li>{% endfor %}</ul>
      {% else %}
        <div class="text-muted tiny">Upload a CSV to preview data.</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // filename label
  document.addEventListener('change', function (e) {
    if (e.target && e.target.id === 'csvFile') {
      const label = document.querySelector('label[for="csvFile"]');
      if (label && e.target.files && e.target.files.length > 0) {
        label.textContent = e.target.files[0].name;
      }
    }
  });

  // when parameter changes, set scale_max default (DBT->50, RH->100) and auto-submit if session exists
  const paramSel = document.getElementById('parameter');
  const genForm  = document.getElementById('genForm');
  const sidInput = document.querySelector('input[name="session_id"]');
  const scaleMax = document.getElementById('scale_max');

  function updateScaleMaxForParam() {
    if (!scaleMax) return;
    const v = paramSel.value;
    if (v === 'DBT')      { scaleMax.value = 50; }
    else if (v === 'RH')  { scaleMax.value = 100; }
  }

  if (paramSel) {
    paramSel.addEventListener('change', () => {
      updateScaleMaxForParam();
      if (genForm && sidInput && sidInput.value) genForm.submit();
    });
    // on load: if empty, set sensible default
    if (!scaleMax.value) updateScaleMaxForParam();
  }
</script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
